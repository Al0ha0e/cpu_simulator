<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>cpu_simulator</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline';"
    />
  </head>
  <body>
    <div id="container">
      <div id="mainScene">
        <div id="tools">
          <input id="asm" type="file" />
          <button id="clear">清零</button>
          <button id="continue">连续执行</button>
          <button id="single">单条指令执行</button>
          <button id="singleMicro">单条微指令执行</button>
        </div>
        <div id="mInstrs">查看微指令</div>
        <div id="instrs">查看指令</div>
      </div>
      <div id="memoryInspector">
        查看并修改寄存器
      </div>
      <div id="waveInspector">233</div>
    </div>
    <script src="./test.js"></script>
    <script src="asmparser.js"></script>
    <script>
      let cpu = new CPU([], 0);
      // Memory Inspector
      let instrInspector = document.getElementById("instrs");
      let microInstrInspector = document.getElementById("mInstrs");
      let memoryInspector = document.getElementById("memoryInspector");
      let microStart = [];
      let regs = [];
      for (let i = 0; i < 32; i++) {
        let reg = document.createElement("div");
        reg.innerHTML = "r" + i.toString() + (i > 9 ? "" : "&nbsp;&nbsp;");
        let inpt = document.createElement("input");
        inpt.value = getHexStr(cpu.reg.memory[i]);
        inpt.style.width = "100px";
        reg.appendChild(inpt);
        let changebtn = document.createElement("button");
        changebtn.innerHTML = "修改";
        let t = i;
        changebtn.onclick = () => {
          //check value
          cpu.reg.memory[t] = inpt.value;
          cpu.reg.show();
        };
        reg.appendChild(changebtn);
        regs.push(reg);
        memoryInspector.appendChild(reg);
      }
      let asm = document.getElementById("asm");
      asm.onchange = () => {
        let files = asm.files;
        let fr = new FileReader();
        fr.readAsText(files[0]);
        fr.onload = () => {
          loadInstr(fr.result);
        };
      };
      //clear
      document.getElementById("clear").onclick = () => {
        let instr = cpu.ir.instrMemory;
        cpu = new CPU(instr, instr.length);
        for (let i = 0; i < 32; i++) {
          regs[i].childNodes[1].value = getHexStr(cpu.reg.memory[i]);
        }
      };
      //continueRun
      let continueRun = document.getElementById("continue");
      continueRun.onclick = () => {
        let pos = cpu.pc.getValue();
        while (pos < cpu.programLength) {
          cpu.update();
          for (let i = 0; i < 32; i++) {
            regs[i].childNodes[1].value = getHexStr(cpu.reg.memory[i]);
          }
          pos = cpu.pc.getValue();
        }
      };
      let premInstrpos = 0;
      //singleRun
      let singleRun = document.getElementById("single");
      singleRun.onclick = () => {
        let pos = cpu.pc.getValue();
        let mpos = cpu.microPC;
        if (pos >= cpu.ir.instrMemory.length) {
          alert("程序结束！");
          return;
        }
        cpu.updateInstr();
        instrInspector.childNodes[pos + 1].style.color = "black";
        microInstrInspector.childNodes[premInstrpos + 1].style.color = "black";
        if (pos >= cpu.ir.instrMemory.length) {
          alert("程序结束！");
          return;
        }
        instrInspector.childNodes[cpu.pc.getValue() + 1].style.color = "red";
        premInstrpos = microStart[cpu.pc.getValue()];
        microInstrInspector.childNodes[premInstrpos + 1].style.color = "red";
        for (let i = 0; i < 32; i++) {
          regs[i].childNodes[1].value = getHexStr(cpu.reg.memory[i]);
        }
      };
      //singleMicroRun
      let singleMicroRun = document.getElementById("singleMicro");
      singleMicroRun.onclick = () => {
        let pos = cpu.pc.getValue();
        if (pos >= cpu.ir.instrMemory.length) {
          alert("程序结束！");
          return;
        }
        cpu.update();
        instrInspector.childNodes[pos + 1].style.color = "black";
        microInstrInspector.childNodes[premInstrpos + 1].style.color = "black";
        if (pos >= cpu.ir.instrMemory.length) {
          alert("程序结束！");
          return;
        }
        instrInspector.childNodes[cpu.pc.getValue() + 1].style.color = "red";
        premInstrpos = microStart[cpu.pc.getValue()] + cpu.microPC;
        microInstrInspector.childNodes[premInstrpos + 1].style.color = "red";
        for (let i = 0; i < 32; i++) {
          regs[i].childNodes[1].value = getHexStr(cpu.reg.memory[i]);
        }
      };
      //style
      document.body.style.height = window.innerHeight + "px";
      document.body.style.width = window.innerWidth + "px";
      window.onresize = () => {
        document.body.style.height = window.innerHeight + "px";
        document.body.style.width = window.innerWidth + "px";
      };
      function loadInstr(str) {
        let instrs = str.split("\n");
        let bitInstr = parse(str);
        cpu = new CPU(bitInstr, bitInstr.length);
        microStart = [0];
        //instr
        instrInspector.childNodes.length = 1;
        microInstrInspector.childNodes.length = 1;
        for (let i = 0; i < instrs.length; i++) {
          let instr = instrs[i];
          let instrdiv = document.createElement("div");
          instrdiv.innerHTML =
            i.toString() +
            "&nbsp;" +
            getHexStr(bitInstr[i]) +
            "&nbsp;&nbsp;" +
            instr;
          instrInspector.appendChild(instrdiv);
          let minstr = controller(bitInstr[i].slice(0, 6));
          microStart[i + 1] = microStart[i] + minstr.length;
          for (let j = 0; j < minstr.length; j++) {
            let minstrdiv = document.createElement("div");
            minstrdiv.innerHTML =
              i.toString() + " " + j.toString() + " " + minstr[j];
            microInstrInspector.appendChild(minstrdiv);
          }
        }
        console.log(microStart);
        instrInspector.childNodes[1].style.color = "red";
        microInstrInspector.childNodes[1].style.color = "red";
      }
    </script>
  </body>
  <style>
    body {
      overflow: hidden;
    }
    #container {
      height: 100%;
      display: grid;
      grid-template-columns: 70% 30%;
      grid-template-rows: 70% 30%;
      grid-template-areas:
        "a b"
        "c b";
    }
    #mainScene {
      border-color: black;
      display: grid;
      grid-template-columns: 50% 50%;
      grid-template-rows: 10% 90%;
      grid-template-areas:
        "x x"
        "y z";
    }
    #asm {
      width: 30px;
    }
    #memoryInspector {
      overflow-y: scroll;
    }
    #tools {
      grid-area: x;
    }
    #instrs {
      grid-area: y;
      overflow-y: scroll;
    }
    #mInstrs {
      grid-area: z;
      overflow-y: scroll;
    }
  </style>
</html>
