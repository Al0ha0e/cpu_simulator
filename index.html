<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>cpu_simulator</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline';"
    />
  </head>
  <body>
    <div id="container">
      <div id="mainScene">
        <div id="tools">
          <input id="asm" type="file" />
          <button id="clear">清零</button>
          <button id="continue">连续执行</button>
          <button id="single">单条指令执行</button>
          <button id="singleMicro">单条微指令执行</button>
        </div>
        <div id="mInstrs">查看微指令</div>
        <div id="instrs">查看指令</div>
      </div>
      <div id="memoryInspector">
        <button id="modeSelect">查看并修改内存</button>
      </div>
      <div id="waveInspector">CPU状态输出</div>
    </div>
    <script src="./test.js"></script>
    <script src="asmparser.js"></script>
    <script>
      let cpu = new CPU([], 0);
      // Memory Inspector
      let instrInspector = document.getElementById("instrs");
      let microInstrInspector = document.getElementById("mInstrs");
      let memoryInspector = document.getElementById("memoryInspector");
      let cpulogger = document.getElementById("waveInspector");
      let microStart = [];
      let regs = [];
      let ram = [];
      //log
      document.addEventListener("cpulog", e => {
        let logitem = document.createElement("div");
        logitem.style.fontSize = "12px";
        logitem.innerHTML = e.detail;
        cpulogger.appendChild(logitem);
        cpulogger.scrollTop = cpulogger.scrollHeight;
      });
      //memory
      for (let i = 0; i < 64; i++) {
        let mem = document.createElement("div");
        mem.innerHTML = i.toString() + (i > 9 ? "" : "&nbsp;&nbsp;");
        let inpt = document.createElement("input");
        inpt.value = getHexStr(cpu.ram.memory[i]);
        inpt.style.width = "100px";
        mem.appendChild(inpt);
        let changebtn = document.createElement("button");
        changebtn.innerHTML = "修改";
        let t = i;
        changebtn.onclick = () => {
          //check value
          let val = parseInt(inpt.value, 16);
          cpu.ram.memory[t] = getBitStr(val);
        };
        mem.appendChild(changebtn);
        ram.push(mem);
      }
      (function() {
        //PC
        let regpc = document.createElement("div");
        regpc.innerHTML = "pc" + "&nbsp;";
        let inpt1 = document.createElement("input");
        inpt1.value = getHexStr(cpu.pc.Value);
        inpt1.style.width = "100px";
        regpc.appendChild(inpt1);
        let changebtn1 = document.createElement("button");
        changebtn1.innerHTML = "修改";
        changebtn1.onclick = () => {
          //check value
          let val = parseInt(inpt1.value, 16);
          cpu.pc.Value = getBitStr(val);
        };
        regpc.appendChild(changebtn1);
        regs.push(regpc);
        memoryInspector.appendChild(regpc);
        //IR
        let regir = document.createElement("div");
        regir.innerHTML = "ir" + "&nbsp;&nbsp;&nbsp;";
        let inpt2 = document.createElement("input");
        inpt2.value = getHexStr(cpu.ir.Value);
        inpt2.style.width = "100px";
        regir.appendChild(inpt2);
        let changebtn2 = document.createElement("button");
        changebtn2.innerHTML = "修改";
        changebtn2.onclick = () => {
          //check value
          let val = parseInt(inpt2.value, 16);
          cpu.ir.Value = getBitStr(val);
        };
        regir.appendChild(changebtn2);
        regs.push(regir);
        memoryInspector.appendChild(regir);
      })();
      //reg
      for (let i = 0; i < 32; i++) {
        let reg = document.createElement("div");
        reg.innerHTML = "r" + i.toString() + (i > 9 ? "" : "&nbsp;&nbsp;");
        let inpt = document.createElement("input");
        inpt.value = getHexStr(cpu.reg.memory[i]);
        inpt.style.width = "100px";
        reg.appendChild(inpt);
        let changebtn = document.createElement("button");
        changebtn.innerHTML = "修改";
        let t = i;
        changebtn.onclick = () => {
          //check value
          let val = parseInt(inpt.value, 16);
          cpu.reg.memory[t] = getBitStr(val);
        };
        reg.appendChild(changebtn);
        regs.push(reg);
        memoryInspector.appendChild(reg);
      }
      let modeSelect = document.getElementById("modeSelect");
      modeSelect.onclick = () => {
        if (modeSelect.innerHTML == "查看并修改内存") {
          for (let i = 0; i < 34; i++) memoryInspector.removeChild(regs[i]);
          for (let i = 0; i < 64; i++) memoryInspector.appendChild(ram[i]);
          modeSelect.innerHTML = "查看并修改寄存器";
        } else {
          for (let i = 0; i < 64; i++) memoryInspector.removeChild(ram[i]);
          for (let i = 0; i < 34; i++) memoryInspector.appendChild(regs[i]);
          modeSelect.innerHTML = "查看并修改内存";
        }
      };
      let asm = document.getElementById("asm");
      asm.onchange = () => {
        let files = asm.files;
        let fr = new FileReader();
        fr.readAsText(files[0]);
        fr.onload = () => {
          while (cpulogger.childNodes.length > 1)
            cpulogger.removeChild(cpulogger.childNodes[1]);
          loadInstr(fr.result);
          regs[0].childNodes[1].value = getHexStr(cpu.pc.Value);
          regs[1].childNodes[1].value = getHexStr(cpu.ir.Value);
          for (let i = 0; i < 32; i++) {
            regs[i + 2].childNodes[1].value = getHexStr(cpu.reg.memory[i]);
          }
          for (let i = 0; i < 64; i++)
            ram[i].childNodes[1].value = getHexStr(cpu.ram.memory[i]);
        };
      };
      let premInstrpos = 0;
      let preInstrpos = 0;
      //clear
      document.getElementById("clear").onclick = () => {
        while (cpulogger.childNodes.length > 1)
          cpulogger.removeChild(cpulogger.childNodes[1]);
        instrInspector.childNodes[preInstrpos + 1].style.color = "black";
        microInstrInspector.childNodes[premInstrpos + 1].style.color = "black";
        instrInspector.childNodes[1].style.color = "red";
        microInstrInspector.childNodes[1].style.color = "red";
        preInstrpos = premInstrpos = 0;
        let instr = cpu.ir.instrMemory;
        cpu = new CPU(instr, instr.length);
        regs[0].childNodes[1].value = getHexStr(cpu.pc.Value);
        regs[1].childNodes[1].value = getHexStr(cpu.ir.Value);
        for (let i = 0; i < 32; i++) {
          regs[i + 2].childNodes[1].value = getHexStr(cpu.reg.memory[i]);
        }
        for (let i = 0; i < 64; i++)
          ram[i].childNodes[1].value = getHexStr(cpu.ram.memory[i]);
      };
      //continueRun
      let continueRun = document.getElementById("continue");
      continueRun.onclick = () => {
        let pos = cpu.pc.getValue();
        let over = false;
        while (!over) {
          over = cpu.update();
          regs[0].childNodes[1].value = getHexStr(cpu.pc.Value);
          regs[1].childNodes[1].value = getHexStr(cpu.ir.Value);
          for (let i = 0; i < 32; i++) {
            regs[i + 2].childNodes[1].value = getHexStr(cpu.reg.memory[i]);
          }
          for (let i = 0; i < 64; i++)
            ram[i].childNodes[1].value = getHexStr(cpu.ram.memory[i]);
        }
        instrInspector.childNodes[preInstrpos + 1].style.color = "black";
        microInstrInspector.childNodes[premInstrpos + 1].style.color = "black";
        let len = cpu.ir.instrMemory.length;
        preInstrpos = len - 1;
        instrInspector.childNodes[len].style.color = "red";
        premInstrpos = microStart[len - 1];
        microInstrInspector.childNodes[premInstrpos + 1].style.color = "red";
      };
      //singleRun
      let singleRun = document.getElementById("single");
      singleRun.onclick = () => {
        let pos = cpu.pc.getValue();
        let mpos = cpu.microPC;
        if (pos >= cpu.ir.instrMemory.length) {
          alert("程序结束！");
          return;
        }
        cpu.updateInstr();
        instrInspector.childNodes[pos + 1].style.color = "black";
        microInstrInspector.childNodes[premInstrpos + 1].style.color = "black";
        if (pos >= cpu.ir.instrMemory.length) {
          alert("程序结束！");
          return;
        }
        preInstrpos = cpu.pc.getValue();
        instrInspector.childNodes[preInstrpos + 1].style.color = "red";
        premInstrpos = microStart[preInstrpos];
        microInstrInspector.childNodes[premInstrpos + 1].style.color = "red";
        regs[0].childNodes[1].value = getHexStr(cpu.pc.Value);
        regs[1].childNodes[1].value = getHexStr(cpu.ir.Value);
        for (let i = 0; i < 32; i++) {
          regs[i + 2].childNodes[1].value = getHexStr(cpu.reg.memory[i]);
        }
        for (let i = 0; i < 64; i++)
          ram[i].childNodes[1].value = getHexStr(cpu.ram.memory[i]);
      };
      //singleMicroRun
      let singleMicroRun = document.getElementById("singleMicro");
      singleMicroRun.onclick = () => {
        let pos = cpu.pc.getValue();
        if (pos >= cpu.ir.instrMemory.length) {
          alert("程序结束！");
          return;
        }
        cpu.update();
        instrInspector.childNodes[pos + 1].style.color = "black";
        microInstrInspector.childNodes[premInstrpos + 1].style.color = "black";
        if (pos >= cpu.ir.instrMemory.length) {
          alert("程序结束！");
          return;
        }
        preInstrpos = cpu.pc.getValue();
        instrInspector.childNodes[preInstrpos + 1].style.color = "red";
        premInstrpos = microStart[preInstrpos] + cpu.microPC;
        microInstrInspector.childNodes[premInstrpos + 1].style.color = "red";
        regs[0].childNodes[1].value = getHexStr(cpu.pc.Value);
        regs[1].childNodes[1].value = getHexStr(cpu.ir.Value);
        for (let i = 0; i < 32; i++) {
          regs[i + 2].childNodes[1].value = getHexStr(cpu.reg.memory[i]);
        }
        for (let i = 0; i < 64; i++)
          ram[i].childNodes[1].value = getHexStr(cpu.ram.memory[i]);
      };
      //style
      document.body.style.height = window.innerHeight + "px";
      document.body.style.width = window.innerWidth + "px";
      window.onresize = () => {
        document.body.style.height = window.innerHeight + "px";
        document.body.style.width = window.innerWidth + "px";
      };
      function loadInstr(str) {
        while (instrInspector.childNodes.length > 1) {
          instrInspector.removeChild(instrInspector.childNodes[1]);
        }
        while (microInstrInspector.childNodes.length > 1) {
          microInstrInspector.removeChild(microInstrInspector.childNodes[1]);
        }
        let instrs = str.split("\n");
        let bitInstr = parse(str);
        cpu = new CPU(bitInstr, bitInstr.length);
        microStart = [0];
        //instr
        instrInspector.childNodes.length = 1;
        microInstrInspector.childNodes.length = 1;
        for (let i = 0; i < instrs.length; i++) {
          let instr = instrs[i];
          let instrdiv = document.createElement("div");
          instrdiv.innerHTML =
            i.toString() +
            "&nbsp;" +
            getHexStr(bitInstr[i]) +
            "&nbsp;&nbsp;" +
            instr;
          instrInspector.appendChild(instrdiv);
          let minstr = controller(bitInstr[i].slice(0, 6));
          microStart[i + 1] = microStart[i] + minstr.length;
          for (let j = 0; j < minstr.length; j++) {
            let minstrdiv = document.createElement("div");
            minstrdiv.innerHTML =
              i.toString() + " " + j.toString() + " " + minstr[j];
            microInstrInspector.appendChild(minstrdiv);
          }
        }
        console.log(microStart);
        instrInspector.childNodes[1].style.color = "red";
        microInstrInspector.childNodes[1].style.color = "red";
      }
    </script>
  </body>
  <style>
    body {
      overflow: hidden;
    }
    #container {
      height: 100%;
      display: grid;
      grid-template-columns: 70% 30%;
      grid-template-rows: 70% 30%;
      grid-template-areas:
        "a b"
        "c b";
    }
    #mainScene {
      grid-area: a;
      border-color: black;
      display: grid;
      grid-template-columns: 50% 50%;
      grid-template-rows: 10% 90%;
      grid-template-areas:
        "x x"
        "y z";
    }
    #asm {
      width: 70px;
    }
    #memoryInspector {
      grid-area: b;
      overflow-y: scroll;
      border-style: solid;
      border-width: 0px 0px 0px 1px;
      border-color: rgb(134, 134, 134);
      padding-left: 25px;
    }
    #tools {
      grid-area: x;
      border-style: solid;
      border-width: 0px 0px 1px 0px;
      border-color: rgb(134, 134, 134);
    }
    #instrs {
      grid-area: y;
      overflow-y: scroll;
      border-style: solid;
      border-width: 0px 1px 0px 0px;
      border-color: rgb(134, 134, 134);
    }
    #mInstrs {
      grid-area: z;
      overflow-y: scroll;
      padding-left: 10px;
    }
    #waveInspector {
      grid-area: c;
      overflow-y: scroll;
      border-style: solid;
      border-width: 1px 0px 0px 0px;
      border-color: rgb(134, 134, 134);
      padding-bottom: 3px;
    }
  </style>
</html>
